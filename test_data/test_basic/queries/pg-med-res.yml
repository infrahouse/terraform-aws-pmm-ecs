---
pg_activity:
  query: |
    SELECT datname, state, wait_event_type, wait_event, COUNT(*) as processes
    , MAX( extract( epoch from clock_timestamp() - xact_start )) FILTER (WHERE xact_start IS NOT NULL AND query !~* '.*autovacuum.*') as in_transaction_seconds
    , MAX( extract( epoch from clock_timestamp() - xact_start )) FILTER (WHERE xact_start IS NOT NULL AND query  ~* '.*autovacuum.*') as in_autovacuum_seconds
    , COUNT(*) FILTER (WHERE cardinality(pg_blocking_pids(pid)) > 0) as blocked
    FROM pg_stat_activity WHERE datname !~ '^(postgres|rdsadmin|template(0|1))$' AND backend_type != 'logical replication worker' AND pid <> pg_backend_pid()
    GROUP BY datname, state, wait_event_type, wait_event
  master: true
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - state:
        usage: "LABEL"
        description: "State of the process"
    - wait_event_type:
        usage: "LABEL"
        description: "Wait event's type (if any)"
    - wait_event:
        usage: "LABEL"
        description: "Wait event (if any)"
    - processes:
        usage: "GAUGE"
        description: "Processes count (per database, state)"
    - in_transaction_seconds:
        usage: "GAUGE"
        description: "Transactions' max duration (per database, state)"
    - in_autovacuum_seconds:
        usage: "GAUGE"
        description: "Transactions' max duration (per database, state)"
    - blocked:
        usage: "GAUGE"
        description: "Number of blocked processes (per database, state)"

pg_stat_user_indexes:
  query: |
    SELECT current_database() as datname, a.schemaname, a.relname as tablename, a.indexrelname as indexname, a.idx_scan, a.idx_tup_read, a.idx_tup_fetch
    , b.idx_blks_read, b.idx_blks_hit
    FROM pg_stat_user_indexes as a LEFT JOIN pg_statio_user_indexes as b ON b.indexrelid = a.indexrelid
  master: false
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema this index is in"
    - tablename:
        usage: "LABEL"
        description: "Name of the table for this index"
    - indexname:
        usage: "LABEL"
        description: "Name of this index"
    - idx_scan:
        usage: "GAUGE"
        description: "Number of index scans initiated on this index"
    - idx_tup_read:
        usage: "GAUGE"
        description: "Number of index entries returned by scans on this index"
    - idx_tup_fetch:
        usage: "GAUGE"
        description: "Number of live table rows fetched by simple index scans using this index"
    - idx_blks_read:
        usage: "COUNTER"
        description: "Blocks read from disk for this index"
    - idx_blks_hit:
        usage: "COUNTER"
        description: "Blocks found in buffer cache for this index"
