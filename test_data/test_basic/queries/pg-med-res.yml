---
# Medium resolution queries - collected every minute
# Keep cardinality reasonable (avoid per-index, per-table metrics)

pg_activity:
  query: |
    SELECT datname, state, wait_event_type, wait_event, COUNT(*) as processes
    , MAX( extract( epoch from clock_timestamp() - xact_start )) FILTER (WHERE xact_start IS NOT NULL AND query !~* '.*autovacuum.*') as in_transaction_seconds
    , MAX( extract( epoch from clock_timestamp() - xact_start )) FILTER (WHERE xact_start IS NOT NULL AND query  ~* '.*autovacuum.*') as in_autovacuum_seconds
    , COUNT(*) FILTER (WHERE cardinality(pg_blocking_pids(pid)) > 0) as blocked
    FROM pg_stat_activity WHERE datname !~ '^(postgres|rdsadmin|template(0|1))$' AND backend_type != 'logical replication worker' AND pid <> pg_backend_pid()
    GROUP BY datname, state, wait_event_type, wait_event
  master: true
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - state:
        usage: "LABEL"
        description: "State of the process"
    - wait_event_type:
        usage: "LABEL"
        description: "Wait event's type (if any)"
    - wait_event:
        usage: "LABEL"
        description: "Wait event (if any)"
    - processes:
        usage: "GAUGE"
        description: "Processes count (per database, state)"
    - in_transaction_seconds:
        usage: "GAUGE"
        description: "Transactions' max duration (per database, state)"
    - in_autovacuum_seconds:
        usage: "GAUGE"
        description: "Transactions' max duration (per database, state)"
    - blocked:
        usage: "GAUGE"
        description: "Number of blocked processes (per database, state)"
